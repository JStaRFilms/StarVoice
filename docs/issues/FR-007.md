# [FR-007] Raw vs Modified Mode Toggle

## Labels
`MUS`, `feature`, `ai`, `ui`

## User Story
As a user, I want to toggle between raw and modified transcription modes, so that I can choose between the original transcript or an AI-refined version.

## Proposed Solution

### Overview
Implement a toggle switch that allows users to select between two transcription modes:
- **Raw Mode**: Direct output from Whisper (verbatim)
- **Modified Mode**: Transcript processed through Kimi-K2 for grammar, clarity, and formatting improvements

The toggle should be easily accessible during recording and persist as a user preference.

### Implementation Flow
1. User selects mode (Raw or Modified) before/during recording
2. Recording completes and basic transcription done
3. If Modified mode:
   - Send raw transcript to Kimi-K2
   - Apply refinement prompt
   - Store refined version separately
4. Display appropriate version in preview
5. Paste the selected version

### Technical Approach

**Mode Toggle Component:**
```tsx
// src/components/ModeToggle.tsx
interface ModeToggleProps {
  mode: 'raw' | 'modified';
  onChange: (mode: 'raw' | 'modified') => void;
}

export function ModeToggle({ mode, onChange }: ModeToggleProps) {
  return (
    <div className="flex items-center gap-2 bg-surface-elevated rounded-lg p-1">
      <button
        onClick={() => onChange('raw')}
        className={cn(
          "px-3 py-1.5 rounded-md text-sm font-medium transition-all",
          mode === 'raw' 
            ? "bg-accent text-background" 
            : "text-foreground-muted hover:text-foreground"
        )}
      >
        Raw
      </button>
      <button
        onClick={() => onChange('modified')}
        className={cn(
          "px-3 py-1.5 rounded-md text-sm font-medium transition-all",
          mode === 'modified' 
            ? "bg-accent text-background" 
            : "text-foreground-muted hover:text-foreground"
        )}
      >
        Modified
      </button>
    </div>
  );
}
```

**Refinement Service:**
```typescript
// src/services/refinement.ts
import { createGroq } from '@ai-sdk/groq';
import { generateText } from 'ai';

const groq = createGroq({
  apiKey: import.meta.env.VITE_GROQ_API_KEY,
});

const REFINEMENT_PROMPT = `Refine the following transcript for clarity and grammar. 
Maintain the original meaning and intent. Fix any transcription errors, 
add proper punctuation, and improve flow:

TRANSCRIPT:
{text}

REFINED:`;

export async function refineTranscript(text: string): Promise<string> {
  const { text: refined } = await generateText({
    model: groq('moonshotai/kimi-k2-instruct-0905'),
    prompt: REFINEMENT_PROMPT.replace('{text}', text),
    maxTokens: 2000,
  });
  
  return refined.trim();
}
```

**Rust Backend:**
```rust
// src-tauri/src/commands/refinement.rs
#[tauri::command]
pub async fn refine_transcript(
    raw_text: String,
    state: State<'_, AppState>,
) -> Result<String, String> {
    let api_key = std::env::var("GROQ_API_KEY")
        .map_err(|_| "API key not configured".to_string())?;
    
    let client = reqwest::Client::new();
    
    let response = client
        .post("https://api.groq.com/openai/v1/chat/completions")
        .bearer_auth(api_key)
        .json(&serde_json::json!({
            "model": "moonshotai/kimi-k2-instruct-0905",
            "messages": [
                {
                    "role": "system",
                    "content": "You are a helpful assistant that refines transcripts for clarity and grammar."
                },
                {
                    "role": "user",
                    "content": format!("Refine this transcript: {}", raw_text)
                }
            ],
            "max_tokens": 2000
        }))
        .send()
        .await
        .map_err(|e| e.to_string())?;
    
    let result: serde_json::Value = response.json().await
        .map_err(|e| e.to_string())?;
    
    result["choices"][0]["message"]["content"]
        .as_str()
        .map(|s| s.to_string())
        .ok_or_else(|| "Invalid response format".to_string())
}
```

### Key Considerations
- Mode preference saved to settings
- Both raw and refined versions stored in database
- Toggle visible in recording overlay and preview
- Modified mode adds slight latency (~1-2 seconds)

## Acceptance Criteria

- [ ] Toggle switch visible in recording UI
- [ ] Raw mode pastes verbatim transcript
- [ ] Modified mode sends transcript to Kimi-K2 for refinement
- [ ] Both versions stored in database
- [ ] Mode preference persists across sessions
- [ ] Visual indicator shows which mode is active
- [ ] Toggle accessible via keyboard shortcut
- [ ] Modified mode clearly shows "processing" state
